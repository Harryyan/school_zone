'use client';

import React, { useEffect, useRef, useState } from 'react';
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';
import type { School } from '@/types';

// Mock zone data - replace with actual API call
const MOCK_ZONE_DATA = {
  "type": "Feature",
  "geometry": {
    "type": "Polygon",
    "coordinates": [
      [
        [174.7828530398144, -36.84509962340538],
        [174.78470404245195, -36.84558254177887],
        [174.78334698742503, -36.840341503229986],
        [174.78491898554716, -36.8404145290124],
        [174.7864780023867, -36.84219955945506],
        [174.78666502775332, -36.84508960686053],
        [174.78827300316928, -36.84657760373394],
        [174.7885980742863, -36.845670558682556],
        [174.78871414717682, -36.84584862944781],
        [174.78840004149887, -36.846701609528594],
        [174.78867810310163, -36.84698260934285],
        [174.78935609373357, -36.84766769800102],
        [174.7910091634615, -36.84782964479853],
        [174.79259713261462, -36.84848369124202],
        [174.79245311007796, -36.848876685078274],
        [174.7922370746436, -36.850306766039786],
        [174.79219010422946, -36.85057670491336],
        [174.791971154352, -36.850796689029025],
        [174.79189617317658, -36.85180768183835],
        [174.79254322638081, -36.852941814594125],
        [174.79300215380945, -36.8533487865796],
        [174.79316420330892, -36.853976738795694],
        [174.79335226484906, -36.855189718509926],
        [174.79321319708583, -36.855895853831214],
        [174.7922181977344, -36.85645284039119],
        [174.7918922405861, -36.85771088901696],
        [174.79139818653715, -36.85821686921793],
        [174.7906411843644, -36.85884686858361],
        [174.79030113946894, -36.85952186811387],
        [174.79005111695346, -36.86024787840948],
        [174.79025825420203, -36.860851900247546],
        [174.79076212232687, -36.86174096032624],
        [174.78890714601093, -36.863294959704206],
        [174.7890151758507, -36.86355499208841],
        [174.79122314784595, -36.863509018935],
        [174.79328824628325, -36.86333996513592],
        [174.79677533585485, -36.86305501121464],
        [174.79719023755717, -36.86219192420708],
        [174.79805328520726, -36.86171792310891],
        [174.79844434008214, -36.86167595145856],
        [174.80107038378057, -36.86215390487674],
        [174.80292444956083, -36.86225792342907],
        [174.8032333738155, -36.862090994883225],
        [174.8034613684409, -36.862212910741725],
        [174.8033333645376, -36.86290897357088],
        [174.80446645217629, -36.8637829238484],
        [174.8043134789802, -36.86437093581704],
        [174.80445838340316, -36.865171015525085],
        [174.80484645420756, -36.8654259683737],
        [174.80437847700426, -36.86555097084159],
        [174.80451445766406, -36.86588095832776],
        [174.8062914982578, -36.86625901762633],
        [174.8065084293434, -36.86593898990038],
        [174.80713351001418, -36.86688300851694],
        [174.8080744513037, -36.86758201125705],
        [174.8085065000055, -36.868897064967115],
        [174.80899247080856, -36.86956296483453],
        [174.80994752188724, -36.87031104007726],
        [174.81023854590265, -36.87090599452564],
        [174.81097154034666, -36.8714610431621],
        [174.81082855422156, -36.87201907600364],
        [174.81060858673897, -36.87284715012141],
        [174.81052253361995, -36.873170057887734],
        [174.81016055211006, -36.873557108693255],
        [174.8093884846362, -36.874442082824466],
        [174.80905548574418, -36.87483121266792],
        [174.8087766006648, -36.87570723016703],
        [174.80854559857192, -36.876178179194966],
        [174.80866547967446, -36.87654220609317],
        [174.80924056130422, -36.87730219828956],
        [174.80957854783483, -36.87826021693243],
        [174.81013555213187, -36.87910421364689],
        [174.81142853415813, -36.879884259903626],
        [174.81185866478444, -36.880381276021005],
        [174.81121357826277, -36.880806267068536],
        [174.80999453188244, -36.881609277272176],
        [174.80910247235062, -36.882210264526165],
        [174.8089125858732, -36.88230833689975],
        [174.8082106178158, -36.88237337391947],
        [174.80678443855606, -36.88322132611197],
        [174.8054095138485, -36.884036304868744],
        [174.80307944145122, -36.885403415015276],
        [174.80242245702527, -36.88578437423195],
        [174.80181945385263, -36.88613738094665],
        [174.8013334287249, -36.886421461479664],
        [174.79998138848921, -36.887212416343324],
        [174.7994854595412, -36.88750538243513],
        [174.79901045612982, -36.887786492504894],
        [174.79775844191497, -36.88853841206135],
        [174.7966983373461, -36.88915852527552],
        [174.7953853465565, -36.88991044109044],
        [174.79426841529403, -36.890592502300635],
        [174.79363534998924, -36.89101153933305],
        [174.7929572767791, -36.89138249015723],
        [174.79130538345908, -36.89236760424017],
        [174.79066626481472, -36.892706588266506],
        [174.78650519558033, -36.892862529903],
        [174.78020422337656, -36.89673760162239],
        [174.7790801202759, -36.899039690892366],
        [174.77845908116785, -36.90131774372783],
        [174.77782315330174, -36.90124370995488],
        [174.7772530843286, -36.9002157047942],
        [174.77614610361348, -36.89938464642422],
        [174.7747920649387, -36.89960173786803],
        [174.7734440033176, -36.898370727236724],
        [174.77388307453714, -36.89954573322049],
        [174.7731070554664, -36.89946466249775],
        [174.7730551422811, -36.902361792265104],
        [174.77205809716824, -36.902716745865014],
        [174.77132201427753, -36.902951707552425],
        [174.76867703814688, -36.902285736731514],
        [174.76820892605474, -36.903457774471484],
        [174.7675259278338, -36.90332381651494],
        [174.76792800262584, -36.90220774584029],
        [174.76687988721105, -36.90196979566028],
        [174.76677597097162, -36.901619819890186],
        [174.76562890936646, -36.90177270803397],
        [174.76492296902165, -36.901601760492476],
        [174.76435391360354, -36.902174722474996],
        [174.7638269286138, -36.90214775767714],
        [174.76403391932104, -36.90139873666768],
        [174.7631228555347, -36.90119477102333],
        [174.7630548519517, -36.90085372270636],
        [174.76332290777987, -36.90000266621043],
        [174.76255188610872, -36.9000946893896],
        [174.75726978036465, -36.898999769488874],
        [174.7570507810523, -36.89872864160709],
        [174.75727082998228, -36.898350699746445],
        [174.7574698124649, -36.897680674774875],
        [174.75773989713005, -36.89682770705789],
        [174.75795582889347, -36.896226653251134],
        [174.75817184181778, -36.89552167341221],
        [174.75993283468551, -36.889785519778435],
        [174.75796878160114, -36.88935554889895],
        [174.75618179617868, -36.88897349288663],
        [174.7550917908804, -36.88872451771055],
        [174.75485168032867, -36.888328500588365],
        [174.75523266178644, -36.88720746282053],
        [174.75560882686187, -36.887047504606],
        [174.75538475178251, -36.88662150720182],
        [174.75574977658414, -36.885534413602784],
        [174.7560937000072, -36.88540746883379],
        [174.755861740389, -36.88500944018875],
        [174.7560567178298, -36.884449439290904],
        [174.75642374028868, -36.884351445745196],
        [174.7562056584267, -36.884064438009986],
        [174.75629073357462, -36.88378142106599],
        [174.7559717266775, -36.88371240701511],
        [174.7556906797512, -36.883522411913795],
        [174.75585470135545, -36.88309040852705],
        [174.75628968722333, -36.8828933450042],
        [174.7560417162513, -36.88255035474061],
        [174.75613578484138, -36.88230731461199],
        [174.75543867059284, -36.882150418554616],
        [174.74969058054552, -36.88084840922507],
        [174.7495195992744, -36.88058340879001],
        [174.74960956322593, -36.8802973498201],
        [174.7498946690347, -36.87944228335277],
        [174.74995662468578, -36.87926137265425],
        [174.75033765734437, -36.8781313345559],
        [174.75058560647435, -36.87737433903568],
        [174.7506196034609, -36.8772663078952],
        [174.75102169926822, -36.87599823191599],
        [174.75147268959284, -36.87459224928273],
        [174.7517306142776, -36.873811218572136],
        [174.75192765162555, -36.873228208855345],
        [174.75220160444664, -36.87237816823093],
        [174.75228357309513, -36.8721112433568],
        [174.7524965730043, -36.871466165067915],
        [174.75271555630763, -36.87080324164385],
        [174.75280855425197, -36.87053308911515],
        [174.75308660133223, -36.86974517862824],
        [174.7537155764629, -36.86792311445112],
        [174.75388260871995, -36.86775606363995],
        [174.75579868438112, -36.86756606397308],
        [174.756591672352, -36.86704607570543],
        [174.7566747017023, -36.86698310616883],
        [174.7568186866206, -36.86687299640759],
        [174.75719465371213, -36.86660108993766],
        [174.75767166241494, -36.866225114781805],
        [174.75777665932344, -36.86617606075215],
        [174.7578466642833, -36.866142035940584],
        [174.75845072550322, -36.865964997304935],
        [174.75893573708603, -36.86445609031771],
        [174.75929267650517, -36.863413990544394],
        [174.75862471620755, -36.86326398005893],
        [174.75882667070425, -36.86261499786916],
        [174.75921666222294, -36.86218297917416],
        [174.7595246799819, -36.86167393644453],
        [174.759773776092, -36.861241929098895],
        [174.7602327007163, -36.8604659248991],
        [174.7603446893316, -36.86024289586343],
        [174.76056176484468, -36.85981388499694],
        [174.7606896667178, -36.8595609656485],
        [174.7611266792771, -36.85857391752306],
        [174.76144679238993, -36.857908848197695],
        [174.76204371056733, -36.8565397801228],
        [174.7623027645726, -36.855946820032216],
        [174.7625607845516, -36.85535784062094],
        [174.76280165781054, -36.85480381675589],
        [174.76293976852543, -36.85446376380745],
        [174.76309672847475, -36.85413379649865],
        [174.76364165681673, -36.8528768076531],
        [174.76388875006234, -36.852359824636764],
        [174.76394676089294, -36.852165715313376],
        [174.7640787324148, -36.85172975895144],
        [174.76454070872373, -36.85089068885544],
        [174.76532676494725, -36.84903567485054],
        [174.7660887736569, -36.849256719734896],
        [174.76676880787855, -36.84945365061525],
        [174.76684875882594, -36.84927273388582],
        [174.7689547555191, -36.84865363788874],
        [174.7698787762513, -36.8483907486565],
        [174.76991069437716, -36.84832068952966],
        [174.7702458423314, -36.84845360333241],
        [174.7724107891388, -36.85021969576014],
        [174.77306783444024, -36.850750700590794],
        [174.7732669331195, -36.85101380643809],
        [174.7734177765482, -36.85133874312604],
        [174.77333481185735, -36.851849780943425],
        [174.77343791902967, -36.85206970231829],
        [174.77366282504394, -36.852308807068454],
        [174.77383784319355, -36.852485742294945],
        [174.77534387302705, -36.850903748961606],
        [174.77589994915905, -36.85113672985134],
        [174.7763739988269, -36.85051979609411],
        [174.7766998975946, -36.85020864782545],
        [174.77708786028978, -36.84986069715602],
        [174.7776569200714, -36.849506701476386],
        [174.77782892919137, -36.84939867123362],
        [174.77908791876945, -36.84897566808781],
        [174.77962292437513, -36.84896270023197],
        [174.78022102370662, -36.84927164578747],
        [174.78165701282666, -36.850014734723615],
        [174.78190296361626, -36.850038718329],
        [174.78223601101013, -36.84971771344406],
        [174.78318605260216, -36.84880464333678],
        [174.7833499696905, -36.848599742182216],
        [174.78354203023974, -36.8476947063625],
        [174.7828530398144, -36.84509962340538]
      ]
    ]
  },
  "properties": {
    "Office": "AK",
    "PolyID": 54,
    "INSTTYPE": "Secondary",
    "PolyName": "Auckland Grammar",
    "SchoolID": 54,
    "ApprovalDate": "2002-09-30",
    "EffectiveDate": "2002-09-30"
  }
};

interface SchoolZoneMapProps {
  school: School;
  className?: string;
}

export default function SchoolZoneMap({ school, className = '' }: SchoolZoneMapProps) {
  const mapContainer = useRef<HTMLDivElement>(null);
  const map = useRef<mapboxgl.Map | null>(null);
  const [isMapLoaded, setIsMapLoaded] = useState(false);

  useEffect(() => {
    if (!mapContainer.current || map.current) return;

    // Set your Mapbox access token
    const token = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;
    
    // Handle mock environment
    if (token === 'mock_token') {
      console.warn('Using mock Mapbox token. Map functionality will be limited.');
      mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
    } else {
      mapboxgl.accessToken = token || 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
    }

    // Initialize the map
    map.current = new mapboxgl.Map({
      container: mapContainer.current,
      style: 'mapbox://styles/mapbox/streets-v11',
      center: school.location ? [school.location.lng, school.location.lat] : [174.7762, -36.8735], // Default to Auckland Grammar School
      zoom: 13
    });

    // Add navigation control
    map.current.addControl(new mapboxgl.NavigationControl(), 'top-right');

    map.current.on('load', () => {
      setIsMapLoaded(true);
      
      // Add the school zone data
      if (map.current) {
        // Add zone source
        map.current.addSource('school-zone', {
          type: 'geojson',
          data: MOCK_ZONE_DATA
        });

        // Add zone fill layer (light green with transparency)
        map.current.addLayer({
          id: 'zone-fill',
          type: 'fill',
          source: 'school-zone',
          paint: {
            'fill-color': '#10b981', // Green color
            'fill-opacity': 0.2
          }
        });

        // Add zone border layer
        map.current.addLayer({
          id: 'zone-border',
          type: 'line',
          source: 'school-zone',
          paint: {
            'line-color': '#059669', // Darker green for border
            'line-width': 2,
            'line-opacity': 0.8
          }
        });

        // Add school marker if location exists
        if (school.location) {
          // Create a custom marker for the school
          const markerElement = document.createElement('div');
          markerElement.className = 'school-marker';
          markerElement.innerHTML = `
            <div style="
              background: #3b82f6;
              border: 3px solid white;
              border-radius: 50%;
              width: 20px;
              height: 20px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            "></div>
          `;

          const marker = new mapboxgl.Marker(markerElement)
            .setLngLat([school.location.lng, school.location.lat])
            .addTo(map.current);

          // Add popup with school info
          const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
            <div class="p-3">
              <h3 class="font-bold text-lg mb-1">${school.name}</h3>
              <p class="text-sm text-gray-600 mb-2">${school.type} School • ${school.gender}</p>
              ${school.address ? `<p class="text-sm text-gray-700">${school.address}</p>` : ''}
            </div>
          `);

          marker.setPopup(popup);
        }

        // Fit the map to show the zone
        const bounds = new mapboxgl.LngLatBounds();
        MOCK_ZONE_DATA.geometry.coordinates[0].forEach(coord => {
          bounds.extend(coord as [number, number]);
        });
        
        map.current.fitBounds(bounds, {
          padding: 50
        });
      }
    });

    // Cleanup function
    return () => {
      if (map.current) {
        map.current.remove();
        map.current = null;
      }
    };
  }, [school]);

  return (
    <div className={`relative ${className}`}>
      <div ref={mapContainer} className="w-full h-full rounded-lg overflow-hidden" />
      
      {!isMapLoaded && (
        <div className="absolute inset-0 bg-gray-100 rounded-lg flex items-center justify-center">
          <div className="text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
            <div className="text-sm text-gray-600">Loading map...</div>
          </div>
        </div>
      )}
      
      {/* Zone legend */}
      <div className="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg p-3">
        <h4 className="font-semibold text-sm mb-2">Map Legend</h4>
        <div className="space-y-1 text-xs">
          <div className="flex items-center">
            <div className="w-4 h-3 bg-green-400 opacity-20 border border-green-600 rounded mr-2"></div>
            <span>School Zone</span>
          </div>
          <div className="flex items-center">
            <div className="w-3 h-3 bg-blue-600 rounded-full border-2 border-white mr-2"></div>
            <span>School Location</span>
          </div>
        </div>
      </div>
    </div>
  );
}